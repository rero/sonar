{# -*- coding: utf-8 -*-
  Swiss Open Access Repository
  Copyright (C) 2019 RERO

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, version 3 of the License.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
#}

{%- extends config.RECORDS_UI_BASE_TEMPLATE %}

{% from 'sonar/macros/macro.html' import dl, dl_dict, dl_list %}

{%- macro record_content(data) %}
{% for key, value in data.items() recursive %}
<li class="list-group-item">
  {% if value is mapping %}
  <strong>{{ key }}:</strong>
  <ul class="list-group">{{ loop(value.items()) }}</ul>
  {% elif value is iterable and value is not string %}
  <strong>{{ key }}:</strong>
  <ol>
    {% for item in value %}
    <li>
      {% if item is mapping %}
      <ul class="list-group">
        {{ record_content(item) }}
      </ul>
      {% else %}
      {{ item }}
      {% endif %}
    </li>
    {% endfor %}
  </ol>
  {% else %}
  <strong>{{ key }}:</strong> {{ value }}
  {% endif %}
</li>
{% endfor %}
{%- endmacro %}

{%- block body %}
<!-- <ul class="list-group">
  {{ record_content(record.replace_refs()) }}
</ul> -->
{% set record = record.replace_refs() %}
<h1 class="text-primary">{{ record.title[0] | title_format(current_i18n.language) }}</h1>
{% if record.institution %}
<h5 class="text-secondary">{{ record.institution.name }}</h5>
{% endif %}

<section class="mt-3">
  <article class="">
    <dl class="row mb-0">
      <!-- AUTHORS -->
      {% if record.authors %}
      {{ dl(_('Authors'), record.pid|authors_format(current_i18n.language, viewcode)) }}
      {% endif %}

      <!-- EDITION STATEMENT-->
      {% if record.editionStatement %}
      {{ dl_list(_('Edition'), record.editionStatement|edition_format) }}
      {% endif %}

      <!-- PUBLICATION STATEMENT -->
      {% for provision_activity in record.provisionActivity %}
      {{ dl_dict(_(provision_activity.type), provision_activity|create_publication_statement ) }}
      {% endfor %}

      <!-- COPYRIGHT DATE -->
      {% if record.copyrightDate %}
      {{ dl(_('Copyright date'), record.copyrightDate|join(', ')) }}
      {% endif %}

      <!-- ABSTRACT -->
      {% if record.abstracts|length > 0 %}
      {{ dl(_('Abstract'), record.abstracts|abstracts_format|nl2br) }}
      {% endif %}

      <!-- PHYSICAL DESCRIPTION -->
      {% if record.extent or record.otherMaterialCharacteristics or record.formats %}
      {% set formats = ', '.join(record.formats) %}
      {% set description = ', '.join([record.extent, record.otherMaterialCharacteristics, formats]|select) %}
      {{ dl(_('Physical description'), description) }}
      {% endif %}

      <!-- ADDITIONAL MATERIALS -->
      {% if record.additionalMaterials %}
      {{ dl(_('Additional Materials'), record.additionalMaterials) }}
      {% endif %}

      <!-- SERIES -->
      {% if record.series|length > 0 %}
      {{ dl(_('Series'), record.series|series_format) }}
      {% endif %}

      <!-- IS PART OF -->
      {% if record.is_part_of %}
      {{ dl(_('Is part of'), record.is_part_of) }}
      {% endif %}

      <!-- SUBJECTS -->
      {% if record.subjects|length > 0 %}
      {{ dl(_('Subjects'), record.subjects|subjects_format|nl2br) }}
      {% endif %}

      <!-- NOTES -->
      {% if record.notes|length > 0 %}
      <dt class="col-sm-2">
        {{ _('Notes') }}:
      </dt>
      <dd class="col-sm-10">
        <ul class="list-unstyled mb-0">
          {% for note in record.notes %}
          <li>
            {{ note }}
          </li>
          {% endfor %}
        </ul>
      </dd>
      {% endif %}

      {% if record.identifiedBy|identifiedby_format|length > 0 %}
      <dt class="col-sm-2">
        {{ _('Identifiers') }}:
      </dt>
      <dd class="col-sm-10">
        <ul class="list-unstyled mb-0">
          {% for identifier in record.identifiedBy|identifiedby_format %}
          <li>
            {{ identifier.value }}
            <small class="badge badge-secondary text-uppercase text-light">{{ identifier.type }}</small>
          </li>
          {% endfor %}
        </ul>
      </dd>
      {% endif %}

      {% if record.language %}
      <dt class="col-sm-2">
        {{ _('Languages') }}:
      </dt>
      <dd class="col-sm-10">
        <ul class="list-unstyled mb-0">
          {% for language in record.language %}
          <li>
            {{ _('lang-' + language.value) }}
          </li>
          {% endfor %}
        </ul>
      </dd>
      {% endif %}

      <!-- PERMANENT LINK -->
      {% set link = url_for('invenio_records_ui.document', pid_value=record.pid, ir=g.ir|default('sonar'), _external=True) %}
      {{ dl(_('Permalink'), '<a href="' + link + '">' + link + '</a>') }}
    </dl>

    {% set pdfs = record._files | files_by_type %}
    {% if pdfs %}
    <h5 class="mt-5">{{ _('Files') }}</h5>

    <table class="table">
      <thead>
        <tr>
          <th>{{ _('File') }}</th>
          <th>{{ _('Size') }}</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for file in pdfs %}
        <tr>
          <td>{{ file.key }}</td>
          <td>{{ file.size | file_size }}</td>
          <td class="text-right">
            {% if file['mime_type'] == 'application/pdf' %}
            <a href="/documents/{{ record.pid }}/preview/{{ file.key }}"
              class="btn btn-secondary btn-sm text-light previewLink"><i class="fa fa-eye"></i>
              {{ _('Preview') }}</a>
            {% endif %}
            <a href="/documents/{{ record.pid }}/files/{{ file.key }}" target="_blank"
              class="btn btn-secondary btn-sm text-light"><i class="fa fa-download"></i> {{ _('Download') }}</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <iframe class="preview-iframe" id="preview-iframe" width="100%" height="500" src=""
      style="border: none; display: none;"></iframe>

    {% endif %}
  </article>
</section>
{%- endblock %}

{% block javascript %}
{{super()}}
<script>
  $(document).ready(function () {
    var $iframe = $('#preview-iframe');

    $('.previewLink').click(function (event) {
      event.preventDefault();
      var link = $(this).attr('href')

      if (link == $iframe.attr('src')) {
        $iframe.attr('src', '').hide(500);
        return;
      }

      $iframe.attr('src', $(this).attr('href')).show(500);
    });
  });
</script>
{% endblock javascript %}
