{# -*- coding: utf-8 -*-
  Swiss Open Access Repository
  Copyright (C) 2019 RERO

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, version 3 of the License.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
#}

{%- extends config.RECORDS_UI_BASE_TEMPLATE %}

{% from 'sonar/macros/macro.html' import dl, dl_dict, dl_list, thumbnail %}

{%- block body %}
{% set record = record.replace_refs() %}
{% set title = record.title[0] | title_format(current_i18n.language) %}

<h1 class="text-primary">{{ title }}</h1>
{% if record.institution %}
<h5 class="text-secondary">{{ _(record.institution.name) }}</h5>
{% endif %}
<section class="mt-3">
  <article class="">
    <div class="row">
      {% set main_file = record._files | files_by_type | first %}
      {% if main_file %}
      {{ thumbnail('documents', record, main_file, 'col-sm-3') }}
      {% endif %}
      <div class="col">
        <dl class="row mb-0">
          <!-- COLLECTION SPECIFIQUE -->
          {% if record.specificCollections %}
          {{ dl_list(_('Specific collections'), record.specificCollections) }}
          {% endif %}

          <!-- CONTRIBUTORS-->
          {% if record.contribution|length > 0 %}
          <dt class="col-sm-3">
            {{ _('Contributions') }}:
          </dt>
          <dd class="col-sm-9">
            <ul class="list-unstyled mb-0">
              {% for contribution in record.contribution %}
              <li>
                <small class="badge badge-secondary text-uppercase text-light">{{ _(contribution.agent.type) }}</small>
                {{ contribution.agent.preferred_name }}
                {% for role in contribution.role %}
                <small class="badge badge-light text-uppercase">{{ _(role) }}</small>
                {% endfor %}
              </li>
              {% endfor %}
            </ul>
          </dd>
          {% endif %}

          <!-- DOCUMENT TYPE -->
          {% if record.documentType %}
          {{ dl(_('Document type'), _(record.documentType)) }}
          {% endif %}

          <!-- EDITION STATEMENT-->
          {% if record.editionStatement %}
          {{ dl(_('Edition'), record.editionStatement.editionDesignation.value ~ ' / ' ~ record.editionStatement.responsibility.value) }}
          {% endif %}

          <!-- PUBLICATION STATEMENT -->
          {% for provision_activity in record.provisionActivity %}
          {{ dl_dict(_(provision_activity.type), provision_activity|create_publication_statement ) }}
          {% endfor %}

          <!-- COPYRIGHT DATE -->
          {% if record.copyrightDate %}
          {{ dl(_('Copyright date'), record.copyrightDate|join(', ')) }}
          {% endif %}

          <!-- ABSTRACT -->
          {% if record.abstracts|length > 0 %}
          {{ dl(_('Abstract'), record.abstracts|abstracts_format|nl2br) }}
          {% endif %}

          <!-- PHYSICAL DESCRIPTION -->
          {% if record.extent or record.otherMaterialCharacteristics or record.formats %}
          {% set formats = ', '.join(record.formats) %}
          {% set description = ', '.join([record.extent, record.otherMaterialCharacteristics, formats]|select) %}
          {{ dl(_('Physical description'), description) }}
          {% endif %}

          <!-- ADDITIONAL MATERIALS -->
          {% if record.additionalMaterials %}
          {{ dl(_('Additional Materials'), record.additionalMaterials) }}
          {% endif %}

          <!-- SERIES -->
          {% if record.series|length > 0 %}
          {{ dl(_('Series'), record.series|series_format) }}
          {% endif %}

          <!-- IS PART OF -->
          {% if record.partOf %}
          <dt class="col-sm-3">
            {{ _('Is part of') }}:
          </dt>
          <dd class="col-sm-9">
            <ul class="list-unstyled mb-0">
              {% for item in record.partOf %}
              <li>{{ item | part_of_format }}</li>
              {% endfor %}
            </ul>
          </dd>
          {% endif %}

          <!-- SUBJECTS -->
          {% if record.subjects|length > 0 %}
          <dt class="col-sm-3">
            {{ _('Subjects') }}:
          </dt>
          <dd class="col-sm-9">
            <ul class="list-unstyled mb-0">
              {% for subject in record.subjects|subjects_format(current_i18n.language) %}
              <li>
                {{ subject.value }}
                {% if subject.source %}
                <small class="badge badge-secondary text-uppercase text-light">{{ subject.source }}</small>
                {% endif %}
              </li>
              {% endfor %}
            </ul>
          </dd>
          {% endif %}

          <!-- NOTES -->
          {% if record.notes|length > 0 %}
          <dt class="col-sm-3">
            {{ _('Notes') }}:
          </dt>
          <dd class="col-sm-9">
            <ul class="list-unstyled mb-0">
              {% for note in record.notes %}
              <li>
                {{ note }}
              </li>
              {% endfor %}
            </ul>
          </dd>
          {% endif %}

          <!-- CONTENT NOTES -->
          {% if record.contentNote|length > 0 %}
          <dt class="col-sm-3">
            {{ _('Contains') }}:
          </dt>
          <dd class="col-sm-9">
            <ul class="list-unstyled mb-0">
              {% for note in record.contentNote %}
              <li>
                {{ note }}
              </li>
              {% endfor %}
            </ul>
          </dd>
          {% endif %}

          {% if record.identifiedBy|identifiedby_format|length > 0 %}
          <dt class="col-sm-3">
            {{ _('Identifiers') }}:
          </dt>
          <dd class="col-sm-9">
            <ul class="list-unstyled mb-0">
              {% for identifier in record.identifiedBy|identifiedby_format %}
              <li>
                {{ identifier.value }}
                <small class="badge badge-secondary text-uppercase text-light">{{ identifier.type }}</small>
              </li>
              {% endfor %}
            </ul>
          </dd>
          {% endif %}

          {% if record.language %}
          <dt class="col-sm-3">
            {{ _('Languages') }}:
          </dt>
          <dd class="col-sm-9">
            <ul class="list-unstyled mb-0">
              {% for language in record.language %}
              <li>
                {{ _('lang-' + language.value) }}
              </li>
              {% endfor %}
            </ul>
          </dd>
          {% endif %}

          {% if record.dissertation %}
          {% if record.dissertation.degree %}
          {{ dl(_('Thesis note'), record.dissertation.degree) }}
          {% endif %}
          {% if record.dissertation.note %}
          {{ dl_list(_('Jury note'), record.dissertation.note) }}
          {% endif %}
          {% endif %}

          <!-- OTHER EDITION -->
          {% if record.otherEdition %}
          <dt class="col-sm-3">
            {{ _('Other editions') }}:
          </dt>
          <dd class="col-sm-9">
            {% for otherEdition in record.otherEdition %}
            <p class="m-0">{{ _(otherEdition.publicNote) }} : <a href="{{ otherEdition.document.electronicLocator }}"
                target="_blank">{{ otherEdition.document.electronicLocator }}</a></p>
            {% endfor %}
          </dd>
          {% endif %}

          {% if record.usageAndAccessPolicy %}
          {{ dl_list(_('Usage and access policy'), record.usageAndAccessPolicy) }}
          {% endif %}

          <!-- PERMANENT LINK -->
          {% set link = url_for('invenio_records_ui.document', pid_value=record.pid, ir=g.ir|default('sonar'), _external=True) %}
          {{ dl(_('Permalink'), '<a href="' + link + '">' + link + '</a>') }}
        </dl>
      </div>
    </div>

    {% set files = record._files | files_by_type %}
    {% if files and files | length > 1 %}
    <h5 class="mt-5">{{ _('Other files') }}</h5>

    <div class="row">
      {% for file in files %}
      {% if loop.index > 1 %}
      {{ thumbnail('documents', record, file, 'col-sm-3 mb-4') }}
      {% endif %}
      {% endfor %}
    </div>
    {% endif %}
  </article>

  <!-- Preview modal -->
  <div class="modal fade" id="previewModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="preview-title">Modal title</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <iframe class="preview-iframe" id="preview-iframe" width="100%" height="800" src=""
            style="border: none;"></iframe>
        </div>
      </div>
    </div>
  </div>
</section>
{%- endblock %}

{% block javascript %}
{{super()}}
<script>
  $(document).ready(function () {
    var $iframe = $('#preview-iframe');
    var $previewTitle = $('#preview-title');

    $('.previewLink').click(function (event) {
      event.preventDefault();
      var link = $(this).attr('href')

      if (link !== $iframe.attr('src')) {
        $iframe.attr('src', $(this).attr('href'));
        $previewTitle.text($(this).data('title'));
      }

      $('#previewModal').modal('show')
    });
  });
</script>
{% endblock javascript %}
