#!/usr/bin/env bash
# -*- coding: utf-8 -*-
#
# Swiss Open Access Repository
# Copyright (C) 2019 RERO
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, version 3 of the License.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

set -e

# Size of data to create
size="minimal"
import=false
local=false
documents_api_url="https://localhost:5000/api/documents/"

while test $# -gt 0; do
    case "$1" in
        --minimal)
            size="minimal"
            ;;
        --small)
            size="small"
            ;;
        --full)
            size="full"
            ;;
        --local)
            local=true
            ;;
        --import)
            import=true
            ;;
        --documents-api-url)
            # Shift to next value for getting option value
            shift
            documents_api_url=$1
            ;;
        *) echo "Option $1 not recognized" ;;
    esac
    shift
done

printf "\nSize of setup is set to \"$size\"\n\n"

# Clean redis
pipenv run invenio shell --no-term-title -c "import redis; redis.StrictRedis.from_url(app.config['CACHE_REDIS_URL']).flushall(); print('Cache cleared')"
pipenv run invenio db destroy --yes-i-know
pipenv run invenio db init create
pipenv run invenio index destroy --force --yes-i-know
pipenv run invenio utils es-init --force # To take templates into account
pipenv run invenio index queue init purge

# Create admin role to restrict access
pipenv run invenio roles create superadmin
pipenv run invenio roles create admin
pipenv run invenio roles create moderator
pipenv run invenio roles create user
pipenv run invenio access allow superuser-access role superadmin
pipenv run invenio access allow admin-access role admin
pipenv run invenio access allow admin-access role moderator

# Create a default location for depositing files
pipenv run invenio fixtures deposits create

# Create configuration for RERODOC OAI harvesting
pipenv run invenio oaiharvester config create data/rerodoc_oai_sources.json

# Create users and organisations
pipenv run invenio fixtures organisations import $(pipenv --where)/data/organisations.json
pipenv run invenio fixtures users import $(pipenv --where)/data/users.json

# Create document sample
if $local; then
    curl -L -H 'Content-Type:application/json' --data-binary "@./data/complete_document_sample.json" -XPOST $documents_api_url --insecure
fi

# Import rerodoc data
if $import; then
    case "$size" in
        full) pipenv run invenio oaiharvester harvest-all ;;
        small) pipenv run invenio oaiharvester harvest-all --max 100 ;;
        *) pipenv run invenio oaiharvester harvest-all --max 10 ;;
    esac
fi
